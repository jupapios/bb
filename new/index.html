<!doctype html>
<html>
<head>
	<title>caju</title>
	<link href='css/normalize.css' rel='stylesheet'>
	<link href='css/main.css' rel='stylesheet'>
	<script>
		Element.prototype.hasClass = function(name) {
			return new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)").test(this.className);
		};
		Element.prototype.addClass = function(name) {
			if (!this.hasClass(name)) {
					this.className = this.className ? [this.className, name].join(' ') : name;
			}
		};
		Element.prototype.toggleClass = function(name) {
			if (!this.hasClass(name)) {
					this.addClass(name);
			} else {
				this.removeClass(name);
			}
		};			
		Element.prototype.removeClass = function(name) {
			if (this.hasClass(name)) {
					var c = this.className;
					this.className = c.replace(new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)", "g"), "");
			}
		};
		NodeList.prototype.addClass = function(name) {
			for(var i=0, len=this.length; i<len; i++) {
				var el = this[i];
				if (!el.hasClass(name)) {
					el.className = el.className ? [el.className, name].join(' ') : name;
				}
			}
		};			
		NodeList.prototype.removeClass = function(name) {
			for(var i=0, len=this.length; i<len; i++) {
				var el = this[i];
				if (el.hasClass(name)) {
						var c = el.className;
						el.className = c.replace(new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)", "g"), "");
				}
			}
		};
		window.$ = function () {
			return document.querySelector.apply(document, arguments);
		};
		window.$$ = function () {
			return document.querySelectorAll.apply(document, arguments);
		};
	</script>
	<script src="js/lib/socket.js"></script>
	<script src="js/lib/handlebars.js"></script>
	<script src="js/lib/box2d.js"></script>
	<script src="js/lib/easel.js"></script>
	<script>
	/*Handlebars.registerHelper('ifCond', function(v1, v2, options) {
	  if(v1 == v2) {
		return options.fn(this);
	  } else {
		return options.inverse(this);
	  }
	});*/
	</script>
</head>
<body class="caju">

		<div class="ball" style="top:20px;left:20px;"></div>

		<div class="main" role="main">
			<section class="caju">
				<h1>caju</h1>
			</section>
		</div>

		<div class="permanent"></div>

		<script id="aside-user" type="text/x-handlebars-template">
			<aside>
				<div><img src="img/user4.png"><span>{{user}}</span></div>
			</aside>
		</script>

		<script id="section-welcome" type="text/x-handlebars-template">
			<section>
				<div class="popup">
					<input type="text" placeholder="what's your name?">
					<a class="button" href="javascript:;">continue!</a>
				</div>
			</section>
		</script>

		<script id="section-intro" type="text/x-handlebars-template">
			<section>
				<nav>
					<ul>
						<li>Play</li>
						<li>Join</li>
					</ul>
				</nav>
			</section>
		</script> 

		<script id="section-join" type="text/x-handlebars-template">
			<section>
				<div class="popup">
					<input type="text" placeholder="invitation">
					<a class="button" href="javascript:;">continue!</a>
				</div>
			</section>
		</script>

		<script id="section-waiting" type="text/x-handlebars-template">
			<section>
				<div class="popup">
					<p>waiting your friend</p>
					<h2>{{id}}</h2>
					<!--<a href="javascript:;">mail it</a>
					<a href="javascript:;">tweet it</a>
					<a href="javascript:;">face it</a>-->
					<p>tell your friend use this number to join</p>
				</div>
			</section>
		</script>

		<script id="section-profile" type="text/x-handlebars-template">
			<section>
				<nav>
					<ul>
						<li class="active">my badges</li>
						<li>options</li>
					</ul>
				</nav>
				<div class="badges">
					{{#each badges}}
					<div class="badge {{this.id}}" onclick="this.toggleClass('active')">
						<div class="face front">
							<img src="img/badges/{{this.id}}.png">
							<!--<p>share</p>-->
						</div>
						<div class="face back">
							<h2>{{this.title}}</h2>
							<p>{{this.description}}</p>
							<ul>
								<!--<li><img src="img/social/rim.png" width="25" height="25"><a href="javascript:;"></a></li>
								<li><img src="img/social/facebook.png" width="25" height="25"><a href="javascript:;"></a></li>
								<li><img src="img/social/twitter.png" width="25" height="25"><a href="javascript:;"></a></li>
								<li><img src="img/social/google.png" width="25" height="25"><a href="javascript:;"></a></li>-->
							</ul>
						</div>
					</div>
					{{/each}}
				</div>
				<div class="options">
					<div class="popup">
						<p>change your name</p>
						<input type="text" placeholder="what's your name?" value="{{user}}">
						<a class="button" href="javascript:;">save!</a>
					</div>
				</div>				
			</section>
		</script>

		<script id="section-game" type="text/x-handlebars-template">
			<section>
				<div class="alert popup">
					<p>your friend ran!</p>
				</div>
				<div class="user-stats enemy"><span>0</span><span>{{enemy}}</span></div>
				<div class="user-stats player"><span>0</span><span>{{player}}</span></div>
				<canvas id="canvas"></canvas>
				<canvas id="debugCanvas" width="1024" height="600"></canvas>
			</section>
		</script>

		<script>
			
			const DEBUG = true;
			const TOUCH_LISTENER = true;
			const CLICK_LISTENER = true;

			//const SOCKET_URL = "http://cajuws.juan.io:80";
			const SOCKET_URL = "http://127.0.0.1:5000";

			// Box2d vars
			var b2Vec2 = Box2D.Common.Math.b2Vec2
				, b2AABB = Box2D.Collision.b2AABB
				, b2BodyDef = Box2D.Dynamics.b2BodyDef
				, b2Body = Box2D.Dynamics.b2Body
				, b2FixtureDef = Box2D.Dynamics.b2FixtureDef
				, b2Fixture = Box2D.Dynamics.b2Fixture
				, b2World = Box2D.Dynamics.b2World
				, b2MassData = Box2D.Collision.Shapes.b2MassData
				, b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
				, b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
				, b2DebugDraw = Box2D.Dynamics.b2DebugDraw
				, b2MouseJointDef =  Box2D.Dynamics.Joints.b2MouseJointDef
			;


			var bodyPly01, bodyPly02;

	         var world = new b2World(
	               new b2Vec2(0, 0)    //gravity
	            ,  false                 //allow sleep
	         );
	         
	         var fixDef = new b2FixtureDef;
	         fixDef.density = 1.0;
	         fixDef.friction = 0.5;
	         fixDef.restitution = 1.1;
	         
	         var bodyDef = new b2BodyDef;
	         
	         //create ground
	         bodyDef.type = b2Body.b2_staticBody;
	         fixDef.shape = new b2PolygonShape;
	         fixDef.shape.SetAsBox(30, 2);

	         bodyDef.position.Set(10, 600 / 30 + 1.8);
	         world.CreateBody(bodyDef).CreateFixture(fixDef);

	         bodyDef.position.Set(10, -1.8);
	         world.CreateBody(bodyDef).CreateFixture(fixDef);


	         fixDef.shape.SetAsBox(2, 14);
	         /*fixDef.friction = 0;
	         fixDef.restitution = 0;   */      

	         bodyDef.position.Set(-300 / 30, 13);
	         world.CreateBody(bodyDef).CreateFixture(fixDef);

	         bodyDef.position.Set((1024 + 300) / 30 + 1.8, 13);
	         world.CreateBody(bodyDef).CreateFixture(fixDef);
	         

	         // helpers

	         var mouseX, mouseY, mousePVec, isMouseDown, selectedBody, mouseJoint, canvasPosition;
	         

         function getBodyAtMouse() {
            mousePVec = new b2Vec2(mouseX, mouseY);
            var aabb = new b2AABB();
            aabb.lowerBound.Set(mouseX - 0.001, mouseY - 0.001);
            aabb.upperBound.Set(mouseX + 0.001, mouseY + 0.001);
            
            // Query the world for overlapping shapes.

            selectedBody = null;
            world.QueryAABB(getBodyCB, aabb);
            return selectedBody;
         }

         function getBodyCB(fixture) {
            if(fixture.GetBody().GetType() != b2Body.b2_staticBody) {
               if(fixture.GetShape().TestPoint(fixture.GetBody().GetTransform(), mousePVec)) {
                  selectedBody = fixture.GetBody();
                  return false;
               }
            }
            return true;
         }

         
         //http://js-tut.aardon.de/js-tut/tutorial/position.html
         function getElementPosition(element) {
            var elem=element, tagname="", x=0, y=0;
           
            while((typeof(elem) == "object") && (typeof(elem.tagName) != "undefined")) {
               y += elem.offsetTop;
               x += elem.offsetLeft;
               tagname = elem.tagName.toUpperCase();

               if(tagname == "BODY")
                  elem=0;

               if(typeof(elem) == "object") {
                  if(typeof(elem.offsetParent) == "object")
                     elem = elem.offsetParent;
               }
            }

            return {x: x, y: y};
         }



			/************************************
			 * Game
			 ************************************/

			var time_1 = DEBUG ? 0: 1400;
			var time_2 = DEBUG ? 0: 800;

			var cancel = false;

			var containerMain = $('.main');
			var containerAside = $('.permanent');
			var source;
			var template;
			var init;
			var instance;
			var stage;
			var world;

			const TOTAL_IMAGES = 3;
			var loadedImages = 0;

			var player_01 = new Image();
			var player_02 = new Image();
			var ball_01 = new Image();

			var stageContainer = new Container();

			// Data from localStorage
			var cajuUser = localStorage.getItem("caju_name");

			// Templates
			var templateJoin = Handlebars.compile($("#section-join").innerHTML);
			var templateWaiting = Handlebars.compile($("#section-waiting").innerHTML);
			var templateGame = Handlebars.compile($("#section-game").innerHTML);
			var templateProfile = Handlebars.compile($("#section-profile").innerHTML);
			var templateAside = Handlebars.compile($("#aside-user").innerHTML);

			window.del = function (element, callback) {
				//var element = $(selector);
				element.addClass("hide");
				setTimeout(function () {
					element.innerHTML = '';
					element.removeClass("hide");
					callback();
				}, time_2);
			}

			var mouseTarget;	// the display object currently under the mouse, or being dragged
			var dragStarted;	// indicates whether we are currently in a drag operation
			var offset;
			var update = true;

			var canvas,
				context,
				debugCanvas,
				debugContext;
	
			function handleImageLoad(event) {
				var image = event.target;

				// create and populate the screen with random daisies:
				this.bitmap = new Bitmap(image);

				for(var option in this.options) {
			        this.bitmap[option] = this.options[option];
			    }

				this.bitmap.regX = this.bitmap.image.width/2|0;
				this.bitmap.regY = this.bitmap.image.height/2|0;


				// wrapper function to provide scope for the event handlers:
				if(this.name == other_player) {
					(function(target) {
						target.onPress = function(evt) {
							// bump the target in front of it's siblings:
							stageContainer.addChild(target);
							var offset = {x:target.x-evt.stageX, y:target.y-evt.stageY};

							// add a handler to the event object's onMouseMove callback
							// this will be active until the user releases the mouse button:
							evt.onMouseMove = function(ev) {
								var x = ev.stageX+offset.x;
								var y = ev.stageY+offset.y;

								var body = getBodyAtMouse();
								if(body) {
									body.SetAwake(true);
								}
								
								if((other_player === 1 && x > 864) || (other_player === 0 && x < 160)) {
									target.x = x;
								} else {
									x = target.x;
								}						
								target.y = y;
								/*if(other_player === 1) {
									bodyPly01.SetPosition(new b2Vec2(x/30,y/30));
								} else {
									bodyPly02.SetPosition(new b2Vec2(x/30,y/30));
								}*/
								socket.emit('move', {
				                    x: x,
				                    y: y
					            });			
								// indicate that the stage should be updated on the next tick:
								update = true;
							}
						}
						target.onMouseOver = function() {
							//target.scaleX = target.scaleY = target.scale*1.2;
							update = true;
						}
						target.onMouseOut = function() {
							//target.scaleX = target.scaleY = target.scale;
							update = true;
						}
					})(this.bitmap);
				}

				stageContainer.addChild(this.bitmap);
				//box2d.createPlayer(this.bitmap);
			}

			// GAME DEFINITION
			var game = {

				//BUTTON FUNCTIONS
				play: function () {
					if(typeof blackberry == "undefined") {
						//webrtc
						if(DEBUG) console.log("TODO: webrtc");
					} else {
						blackberry.launch.launchCamera();
					}
					if(DEBUG) console.log('Click: new');
					if(connection_ready) {
						socket.emit('new', cajuUser);
						other_player = 1
					}					
				},
				join: function () {
					del(containerMain, function () {
						containerMain.innerHTML = templateJoin();
						document.body.className = "join";

						var anchor = containerMain.querySelector('a');

						function joinGame () {
							var instanceId = this.parentElement.querySelector("input").value;
							if(instanceId) {
								socket.emit('join', {instanceId:instanceId, player:cajuUser});

								instance = instanceId;
								other_player = 0;
							} else {
								var self = this;
								self.parentElement.addClass("error");
								setTimeout(function () {
									self.parentElement.removeClass("error");
								}, 700);
							}
						}
						
						anchor.addEventListener('click', joinGame);
						anchor.addEventListener('touch', joinGame);

					});
				},

				showProfile: function () {
					del(containerMain, function () {
						containerMain.innerHTML = templateProfile({
																	user: cajuUser,
																	badges: [
																		{
																			  id: 'beta-tester'
																			, title: 'Beta Tester'
																			, description : 'le description'
																		}
																		, {
																			  id: 'strategist'
																			, title: 'Strategist'
																			, description : 'le description'
																		}
																		, {
																			  id: 'team'
																			, title: 'Caju Team'
																			, description : 'le description'
																		}
																		, {
																			  id: 'wins-100'
																			, title: 'Winner Master'
																			, description : 'le description'
																		}
																		, {
																			  id: 'agile'
																			, title: 'Agile'
																			, description : 'le description'
																		}
																	]
																});

						var mainMenu = containerMain.querySelectorAll("nav li");

						if(TOUCH_LISTENER) {
							mainMenu[0].addEventListener('touch', function () {
								document.querySelector('.options').style.display = 'none';
								this.parentElement.querySelector('li:nth-child(2)').removeClass('active');
								this.addClass('active');
								document.querySelector('.badges').removeClass('to-left');
							});
							mainMenu[1].addEventListener('touch', function () {
								this.parentElement.querySelector('li:nth-child(1)').removeClass('active');
								this.addClass('active');
								document.querySelector('.badges').addClass('to-left');
								setTimeout(function () {
									document.querySelector('.options').style.display = 'inline-block';
								}, 300);
							});
						}


						if(CLICK_LISTENER) {
							mainMenu[0].addEventListener('click', function () {
								document.querySelector('.options').style.display = 'none';
								this.parentElement.querySelector('li:nth-child(2)').removeClass('active');
								this.addClass('active');
								document.querySelector('.badges').removeClass('to-left');
							});
							mainMenu[1].addEventListener('click', function () {
								this.parentElement.querySelector('li:nth-child(1)').removeClass('active');
								this.addClass('active');
								document.querySelector('.badges').addClass('to-left');
								setTimeout(function () {
									document.querySelector('.options').style.display = 'inline-block';
								}, 300);
							});
						}						
						var anchor = containerMain.querySelector('.options a');

						if(TOUCH_LISTENER) {
							anchor.addEventListener('touch', function () {
								var inputValue = this.parentElement.querySelector("input").value;
								if(game.save(inputValue)) {
									init();	
								} else {
									var self = this;
									self.parentElement.addClass("error");
									setTimeout(function () {
										self.parentElement.removeClass("error");
									}, 700);
								}
							});
						}

						if(CLICK_LISTENER) {
							anchor.addEventListener('click', function () {
								var inputValue = this.parentElement.querySelector("input").value;
								if(game.save(inputValue)) {
									init();	
								} else {
									var self = this;
									self.parentElement.addClass("error");
									setTimeout(function () {
										self.parentElement.removeClass("error");
									}, 700);
								}
							});
						}

						/*var badges = containerMain.querySelectorAll(".badge");
						var badge = null;
						for(var i=0, len=badges.length; i<len; i++) {
							badge = badges[i];
							badge.addEventListener('click', function () {
								if(this.hasClass('active')) {
									this.removeClass('active');
								} else {
									badges.removeClass('active');
									this.addClass('active');
								}
							});
						}*/
						document.body.className = "profile";
					});
				},

				save: function (inputValue) {
					if(inputValue) {
						cajuUser = inputValue;
						localStorage.setItem("caju_name", cajuUser);
						return true;
					}
					return false;
				},

				// GAME FUNCTIONS
				wait: function (id) {
					del(containerMain, function () {
						containerMain.innerHTML = templateWaiting({id:id});
						document.body.className = "waiting";
					});
				},

				start: function (enemy) {
					//containerMain.innerHTML = templateGame({player:cajuUser});
					containerMain.innerHTML = templateGame({player:cajuUser, enemy:enemy});
					document.body.className = "game";
					document.body.removeChild($('.ball'));

					//Canvas work
					canvas = $('#canvas');
					context = canvas.getContext("2d");

					debugCanvas = $('#debugCanvas');
					debugContext = debugCanvas.getContext("2d");

					canvas.width = 1024;
					canvas.height = 600;



					if(other_player === 1) {
				         // BEGIN BALL
				         bodyDef.type = b2Body.b2_dynamicBody;
				         fixDef.shape = new b2CircleShape(50/30);

				         bodyDef.position.x = (1024/2 + 300)/30;
				         bodyDef.position.y = (600/2)/30;
				         bodyDef.userData = 0;
				         //world.CreateBody(bodyDef).CreateFixture(fixDef);
				         var bodyBall = world.CreateBody(bodyDef);
				         bodyBall.CreateFixture(fixDef);
				         //bodyBall.SetLinearVelocity(new b2Vec2(3,0));
				         // END BALL
	     			}



	         bodyDef.type = b2Body.b2_dynamicBody;
	         //bodyDef.angularDamping = 3;
	         bodyDef.fixedRotation = true;
	         fixDef.restitution = 1.2;

	         // BEGIN PLAYER01
	         fixDef.shape = new b2PolygonShape;
	         fixDef.shape.SetAsBox(356/60,160/60);
	         bodyDef.position.x = -80/30;
	         bodyDef.position.y = 310/30;
	         bodyDef.userData = 1;
	         bodyPly01 = world.CreateBody(bodyDef);
	         bodyPly01.CreateFixture(fixDef);
	         bodyPly01.SetLinearVelocity(new b2Vec2(3,0));
	         // END PLAYER01


	         // BEGIN PLAYER02
	         fixDef.shape = new b2PolygonShape;
	         fixDef.shape.SetAsBox(356/60,160/60);
	         bodyDef.position.x = 1100/30;
	         bodyDef.position.y = 310/30;
	         bodyDef.userData = 2;
	         bodyPly02 = world.CreateBody(bodyDef);
	         bodyPly02.CreateFixture(fixDef);
	         bodyPly02.SetLinearVelocity(new b2Vec2(-3,0));
	         // END PLAYER02


					var debugDraw = new b2DebugDraw();
		            debugDraw.SetSprite(debugContext);
		            debugDraw.SetDrawScale(30.0);
		            debugDraw.SetFillAlpha(0.5);
		            debugDraw.SetLineThickness(1.0);
		            debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
		            world.SetDebugDraw(debugDraw);



		            canvasPosition = getElementPosition(document.getElementById("canvas"));

			var listener = new Box2D.Dynamics.b2ContactListener;
			var k=150;
		    listener.BeginContact = function(contact) {
		    	console.log(contact.GetFixtureA().GetBody().GetUserData(), contact.GetFixtureB().GetBody().GetUserData())
		         if (contact.GetFixtureA().GetBody().GetUserData()== 1 && contact.GetFixtureB().GetBody().GetUserData()== 0 ) {
		         	//bodyBall.ApplyImpulse(new b2Vec2(-150,0), bodyBall.GetWorldCenter())
		         	console.log('aplica a blanco')
		         } else if (contact.GetFixtureA().GetBody().GetUserData()== 2 && contact.GetFixtureB().GetBody().GetUserData()== 0 ) {
		         	//bodyBall.ApplyImpulse(new b2Vec2(150,0), bodyBall.GetWorldCenter())
		         	console.log('aplica a negro')
		         }
		         k += 10;
		     }
		    listener.EndContact = function(contact) {
		         if (contact.GetFixtureA().GetBody().GetUserData()== 0 || contact.GetFixtureB().GetBody().GetUserData()== 0 ) {

		         }
		     }

             world.SetContactListener(listener);


			         function handleMouseMove(e) {
			            mouseX = (e.clientX - canvasPosition.x) / 30;
			            mouseY = (e.clientY - canvasPosition.y) / 30;
			         };

			       /* document.addEventListener("mousedown", function(e) {
			            isMouseDown = true;
			            handleMouseMove(e);
			            document.addEventListener("mousemove", handleMouseMove, true);
			         }, true);
			         
			         document.addEventListener("mouseup", function() {
			            document.removeEventListener("mousemove", handleMouseMove, true);
			            isMouseDown = false;
			            mouseX = undefined;
			            mouseY = undefined;
			         }, true);*/


					stage = new Stage(canvas);
					stage.snapPixelsEnabled = true;

					Ticker.setFPS(30);
					Ticker.useRAF = true;
					Ticker.addListener(window);

					// enable touch interactions if supported on the current device:
					Touch.enable(stage);

					// enabled mouse over / out events
					stage.enableMouseOver(10);
					//stage.mouseMoveOutside = true; // keep tracking the mouse even when it leaves the canvas
					stage.addChild(stageContainer);


					// BALL
					ball_01.onload = function (event) {
						var image = event.target;
						this.bitmap = new Bitmap(image);

				        this.bitmap.x = canvas.width/2|0 + 300;
				        this.bitmap.y = canvas.height/2|0;
				        this.bitmap.regX = this.bitmap.image.width/2|0;
						this.bitmap.regY = this.bitmap.image.height/2|0;

						stageContainer.addChild(this.bitmap);
						update = true;

					};
					ball_01.onerror = function (e) {
						console.log(e);
					};
					ball_01.src = "img/ball.png";

					// PLAYERS
					// load the source image:
					player_01.options = {
						  x: 1100
						, y: 310
						, rotation: 90
					}
					player_01.onload = handleImageLoad;
					player_01.name = 1;
					player_01.src = "img/player_01.png";


					player_02.options = {
						  x: -80
						, y: 280
						, rotation: -90
					}
					player_02.onload = handleImageLoad;
					player_02.name = 0;
					player_02.src = "img/player_02.png";

				}
			}


			init = function() {
				if(cajuUser) {
					source  = $("#section-intro").innerHTML;
				} else {
					source  = $("#section-welcome").innerHTML;
				}

				template = Handlebars.compile(source);

				setTimeout(function () {
					del(containerMain, function () {

						if(cajuUser) { // rendering intro section
							containerMain.innerHTML = template();
							containerAside.innerHTML = templateAside({user:cajuUser});

							// user action
							var userLink = containerAside.querySelector("aside div");

							var li = containerMain.querySelectorAll('li');

							if(TOUCH_LISTENER) {
								li[0].addEventListener('touch', game.play);
								li[1].addEventListener('touch', game.join);

								userLink.addEventListener('touch', game.showProfile);
							}

							if(CLICK_LISTENER) {
								li[0].addEventListener('click', game.play);
								li[1].addEventListener('click', game.join);

								userLink.addEventListener('click', game.showProfile);
							}

							document.body.className = "intro";

						} else { //rendering welcome section
							containerMain.innerHTML = template();
							var anchor = containerMain.querySelector('a');

							if(TOUCH_LISTENER) {
								anchor.addEventListener('touch', function () {
									var inputValue = this.parentElement.querySelector("input").value;
									if(game.save(inputValue)) {
										init();	
									} else {
										var self = this;
										self.parentElement.addClass("error");
										setTimeout(function () {
											self.parentElement.removeClass("error");
										}, 700);
									}
								});
							}

							if(CLICK_LISTENER) {
								anchor.addEventListener('click', function () {
									var inputValue = this.parentElement.querySelector("input").value;
									if(game.save(inputValue)) {
										init();	
									} else {
										var self = this;
										self.parentElement.addClass("error");
										setTimeout(function () {
											self.parentElement.removeClass("error");
										}, 700);
									}
								});
							}

							document.body.className = "welcome";
						}
					});
				}, time_1);
			};

			/************************************
			 * Ball
			 ************************************/

			var ball = $(".ball");
			var moving = false;
			var initialX, initialY;

			function move_ball (e) {

				e.preventDefault();

				var x = e.x || e.offsetX || (e.pageX - ball.offsetLeft);
				var y = e.y || e.offsetY || (e.pageY - ball.offsetTop);
				if(moving) {
					if(y > 0 && y < (window.innerHeight - 40)) {
						ball.style.top = parseInt(ball.style.top) + (y-initialY) +"px";	
					}
					if(x > 0 && x < (window.innerWidth - 40)) {
						ball.style.left = parseInt(ball.style.left) + (x-initialX) +"px";	
					}
					initialX = x;
					initialY = y;
				}
			}

			if(TOUCH_LISTENER) {

				window.addEventListener("touchend", function () {
					document.body.removeClass("no-select");
					moving = false;
				}, false);

				ball.addEventListener("touchstart", function (e) {
					initialX = e.x || e.offsetX || (e.pageX - ball.offsetLeft);
					initialY = e.y || e.offsetY || (e.pageY - ball.offsetTop);;
					document.body.addClass("no-select");
					moving = true;
				}, false);

			}

			if(CLICK_LISTENER) {

				window.addEventListener("mousemove", move_ball, false);

				window.addEventListener("mouseup", function () {
					document.body.removeClass("no-select");
					moving = false;
				}, false);


				ball.addEventListener("mousedown", function (e) {
					initialX = e.x || e.offsetX || (e.pageX - ball.offsetLeft);
					initialY = e.y || e.offsetY || (e.pageY - ball.offsetTop);
					document.body.addClass("no-select");
					moving = true;
				}, false);
			}

			window.addEventListener("devicemotion", function(event) {
				if(window.orientation == 90) {
					var x = parseInt(ball.style.left) - event.accelerationIncludingGravity.y;
					var y = parseInt(ball.style.top) - event.accelerationIncludingGravity.x;

					if(x > 0 && x < (window.innerWidth - 40)) ball.style.left =  x + 'px'; 
					if(y > 0 && y < (window.innerHeight - 40)) ball.style.top = y + 'px';            		
				} else if(window.orientation == -90) {
					var x = parseInt(ball.style.left) + event.accelerationIncludingGravity.y;
					var y = parseInt(ball.style.top) + event.accelerationIncludingGravity.x;

					if(x > 0 && x < (window.innerWidth - 40)) ball.style.left =  x + 'px'; 
					if(y > 0 && y < (window.innerHeight - 40)) ball.style.top = y + 'px';       
				}

				/*if(DEBUG) {
					if(window.orientation == 90) {
						var x = parseInt(ball.style.top) - event.accelerationIncludingGravity.x;
						var y = parseInt(ball.style.left) - event.accelerationIncludingGravity.y;

						if(x < window.innerHeight && x > 0) ball.style.top =  x + 'px'; 
						if(y < window.innerWidth && y > 0) ball.style.left = y + 'px'; 
					} else if(window.orientation == -90) {
						var x = parseInt(ball.style.top) + event.accelerationIncludingGravity.x;
						var y = parseInt(ball.style.left) + event.accelerationIncludingGravity.y;

						if(x < window.innerHeight && x > 0) ball.style.top =  x + 'px'; 
						if(y < window.innerWidth && y > 0) ball.style.left = y + 'px'; 
					}
				}*/
			}, true); 




			function tick() {
				if(cancel) return;
				else {
					bodyPly01.SetPosition(new b2Vec2(player_01.bitmap.x/30,player_01.bitmap.y/30));
					bodyPly02.SetPosition(new b2Vec2(player_02.bitmap.x/30,player_02.bitmap.y/30));
					//box2d.update();

					var body = getBodyAtMouse();

		            if(body) {
		               if(isMouseDown && (!mouseJoint) && body.GetUserData() !== 0) {

		                  var md = new b2MouseJointDef();

		                  md.bodyA = world.GetGroundBody();
		                  md.bodyB = body;
		                  md.target.Set(mouseX, mouseY);
		                 // console.log(body);
		                  md.collideConnected = true;
		                  md.maxForce = 300.0 * body.GetMass();
		                  mouseJoint = world.CreateJoint(md);
		                  body.SetAwake(true);
		                  /*world.DestroyJoint(mouseJoint);
		                  mouseJoint = null;*/
		               }
		            
		            }
		            
		            if(mouseJoint) {
		               if(isMouseDown) {
		                  mouseJoint.SetTarget(new b2Vec2(mouseX, mouseY));
		               } else {
		                  world.DestroyJoint(mouseJoint);
		                  mouseJoint = null;
		               }
		            }					
					world.Step(1 / 60, 10, 10);
            		world.DrawDebugData();
            		world.ClearForces();

		 			for (b = world.GetBodyList() ; b; b = b.GetNext()) {
		               var type = b.GetUserData();
		               var pos = b.GetPosition();

		               //ball
		               if (type === 0) {
		                  ball_01.bitmap.x = pos.x * 30;
		                  ball_01.bitmap.y = pos.y * 30;

		                  socket.emit('ball', {
		                    x: pos.x,
		                    y: pos.y
					      });	

		                  if(ball_01.bitmap.x <= 4) {
		                     console.log('PUNTO PA 0');
		                     //init();
		                  } else if(ball_01.bitmap.x >= 1020) {
		                     console.log('PUNTO PAL 1');
		                     //init();
		                  }
		               }

		            }	

					stage.update();
				}
				/*if (update) {
					update = false; // only update once
				}*/
			}				



			/************************************
			 * Socket
			 ************************************/

			var connection_ready = false;

			if(typeof io !== "undefined") {

				socket = io.connect(SOCKET_URL, {
					'reconnect': true
					, 'reconnection delay': 500
					, 'max reconnection attempts': 5
				});

				socket.on('connect', function () {
					connection_ready = true;
					init();
					if(DEBUG) console.log('OPEN');
				});

				socket.on('join', function (data) {
					other_player = 0;
					if(data) {
						//do something
					} else {
						var div = $('.main div');
						div.addClass("error");
						setTimeout(function () {
							div.removeClass("error");
						}, 700);
					}
				});

				socket.on('new', function (data) {
					//console.log(data);
					game.wait(data.id);
				});

				socket.on('move', function (data) {
					var x = data.x;
					var y = data.y;
					if(other_player === 1) {
						if(x < 160) {
							player_02.bitmap.x = x;
						} else {
							x = player_02.bitmap.x;
						}
						player_02.bitmap.y = y;
						//bodyPly02.SetPosition(new b2Vec2(x/30,y/30));
					} else {
						if(x > 864) {
							player_01.bitmap.x = x;
						} else {
							x = player_01.bitmap.x;
						}
						player_01.bitmap.y = y;
						//bodyPly01.SetPosition(new b2Vec2(x/30,y/30));
					}
					update = true;
				});

				socket.on('ball', function (data) {
					ball_01.bitmap.x = data.x*30;
					ball_01.bitmap.y = data.y*30;
				});


				socket.on('bye', function (data) {
					cancel = true;
					containerMain.addClass("no-active");
				});				

				socket.on('ready', function (enemy) {
					cancel = false;
					del(containerMain, function () {
						game.start(enemy);
					});
					/*del(container, function () {
						container.innerHTML = template_choose({user:cajuUser, player:other_player});
						document.body.className = "choose";
					});*/
				});
			}

		</script>
</body>
</html>